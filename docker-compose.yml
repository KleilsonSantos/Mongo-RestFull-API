# ğŸ› ï¸ Services configuration
services:
  mongo-rest-api:
    image: santos/mongo-rest-api:1.0 # ğŸ“¦ Image
    container_name: mongo-rest-api # ğŸ·ï¸ Container name
    ports:
      - '3000:3000' # ğŸŒ Port mapping
    depends_on:
      - mongo # ğŸ”„ Depends on MongoDB service
    env_file:
      - .env.development # ğŸ“„ Environment file
    environment:
      - MONGODB_URI=${MONGODB_URI} # ğŸ”‘ MongoDB URI
    volumes:
      - .:/usr/src/app:delegated # ğŸ’¾ Volume for data persistence
    restart: unless-stopped # ğŸ” Automatically restarts if it stops

  portainer:
    image: portainer/portainer-ce:latest # ğŸ“¦ Portainer CE (Community Edition) image

    env_file:
      - .env.development # ğŸ“„ Environment file
    container_name: portainer-mongo-rest-api # ğŸ·ï¸ Container name
    restart: always # ğŸ” Automatically restarts if it stops
    ports:
      - '9099:9000' # ğŸŒ Web access
      - '8000:8000' # ğŸ› ï¸ Agent access
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # ğŸ§© Direct communication with Docker
      - portainer-data:/data # ğŸ’¾ Volume for data persistence
    environment:
      - TZ=America/Sao_Paulo # ğŸ•’ Set the timezone
    security_opt:
      - no-new-privileges:true # ğŸ” Prevent privilege escalation
  # ğŸ’¾ MongoDB service
  mongo:
    image: mongo
    container_name: mongo-mongo-rest-api # ğŸ·ï¸ Container name
    env_file:
      - .env.development # ğŸ“„ Environment file
    # ğŸŒ Port mapping
    ports:
      - '27017:27017'
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME} # ğŸ”‘ MongoDB admin username
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD} # ğŸ”‘ MongoDB admin password
      - MONGODB_URI=${MONGODB_URI} # ğŸ”‘ MongoDB URI
      - NODE_ENV=${NODE_ENV} # ğŸ”‘ Node environment
    # ğŸ“ Volume mapping for data persistence
    volumes:
      - mongo-data:/data/db # ğŸ’¾ Volume for data persistence
  mongo-express:
    image: mongo-express:1.0.0-alpha.4 # ğŸ“¦ Mongo Express image
    container_name: mongo-express-mongo-rest-api # ğŸ·ï¸ Container name
    env_file:
      - .env.development # ğŸ“„ Environment file
    restart: always # ğŸ” Automatically restarts if it stops
    ports:
      - '8081:8081' # ğŸŒ Port mapping
    environment:
      - ME_CONFIG_MONGODB_ADMIN_USERNAME=${MONGO_INITDB_ROOT_USERNAME} # ğŸ”‘ MongoDB admin username
      - ME_CONFIG_MONGODB_ADMIN_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD} # ğŸ”‘ MongoDB admin password
      - ME_CONFIG_MONGODB_SERVER=${MONGO_INITDB_ROOT_USERNAME} # ğŸ”‘ MongoDB server
    depends_on:
      - mongo # ğŸ”„ Depends on MongoDB service

  prometheus:
    image: prom/prometheus # ğŸ“¦ Prometheus image
    container_name: prometheus-mongo-rest-api # ğŸ·ï¸ Container name
    env_file:
      - .env.development # ğŸ“„ Environment file
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml # ğŸ’¾ Volume for configuration
    ports:
      - '9090:9090' # ğŸŒ Port mapping

  grafana:
    image: grafana/grafana # ğŸ“¦ Grafana image
    container_name: grafana-mongo-rest-api # ğŸ·ï¸ Container name
    env_file:
      - .env.development # ğŸ“„ Environment file
    ports:
      - '3001:3000' # ğŸŒ Port mapping
    volumes:
      - grafana-storage:/var/lib/grafana # ğŸ’¾ Volume for data persistence
    extra_hosts:
      - '172.17.0.1:host-gateway' # ğŸŒ Extra hosts
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER} # ğŸ”‘ Grafana admin user
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD} # ğŸ”‘ Grafana admin password
      - GF_AUTH_DISABLE_LOGIN_FORM=${GF_AUTH_DISABLE_LOGIN_FORM} # ğŸ”‘ Disable login form
      - GF_AUTH_ANONYMOUS_ENABLED=${GF_AUTH_ANONYMOUS_ENABLED} # ğŸ”‘ Enable anonymous access

  # ğŸ› ï¸ PostgreSQL for Sonar
  postgres:
    image: postgres:14 # ğŸ“¦ PostgreSQL 14 image
    container_name: postgres-mongo-rest-api # ğŸ·ï¸ Container name
    env_file:
      - .env.development # ğŸ“„ Environment file
    ports:
      - '5432:5432' # ğŸŒ Web access
    restart: always # ğŸ” Automatically restarts if it stops
    environment:
      POSTGRES_DB: ${POSTGRES_DB} # ğŸ“¦ Database name
      POSTGRES_USER: ${POSTGRES_USER} # ğŸ‘¤ Database username
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} # ğŸ”‘ Database password
      POSTGRES_INITDB_ARGS: '--encoding=UTF8 --locale=en_US.UTF-8' # ğŸŒ Database encoding and locale
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256 # ğŸ” Authentication method
    volumes:
      - postgres-mongo-rest-api-data:/var/lib/postgresql/data # ğŸ’¾ Volume for data persistence
  
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin-mongo-rest-api # ğŸ·ï¸ Container name
    env_file:
      - .env.development # ğŸ“„ Environment file
    ports:
      - "8088:80" # Porta para acessar o pgAdmin
    depends_on:
      - postgres
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
    volumes:
      - pgadmin-mongo-rest-api-data:/pgadmin4/servers.json
  
  sonar:
    image: sonarqube:latest
    container_name: sonar-mongo-rest-api # ğŸ·ï¸ Container name
    env_file:
      - .env.development # ğŸ“„ Environment file
    ports:
      - '9000:9000'
      - '9092:9092'
    environment:
      - SONAR_JDBC_URL=${SONAR_JDBC_URL} # ğŸ˜ PostgreSQL connection URL
      - SONAR_JDBC_USERNAME=${SONAR_JDBC_USERNAME} # ğŸ‘¤ Database username
      - SONAR_JDBC_PASSWORD=${SONAR_JDBC_PASSWORD} # ğŸ”‘ Database password
      - SONARQUBE_JVM_OPTIONS='-Xmx4G -Xms4G' # ğŸ“Š JVM memory configuration
    volumes:
      - sonar-mongo-rest-api-data:/opt/sonarqube/data # ğŸ’¾ Volume for data persistence
      - sonar-mongo-rest-api-logs:/opt/sonarqube/logs # ğŸ“œ Volume for logs
      - sonar-mongo-rest-api-extensions:/opt/sonarqube/extensions # ğŸ“¦ Volume for extensions

# ğŸ“ Volumes definition
volumes: # ğŸ’¾ Volumes for data persistence
  mongo-data: # ğŸ’¾ MongoDB data volume
    driver: local # ğŸ’¾ Local driver
  portainer-data: # ğŸ’¾ Portainer data volume
    driver: local # ğŸ’¾ Local driver
  grafana-storage: # ğŸ’¾ Grafana data volume
    driver: local # ğŸ’¾ Local driver
  postgres-mongo-rest-api-data: # ğŸ’¾ PostgreSQL data volume
    driver: local # ï¿½ï¿½ Local driver
  sonar-mongo-rest-api-data: # ğŸ’¾ Sonar data volume
    driver: local # ğŸ’¾ Local driver
  sonar-mongo-rest-api-logs: # ğŸ’¾ Sonar logs volume
    driver: local # ğŸ’¾ Local driver
  sonar-mongo-rest-api-extensions: # ğŸ’¾ Sonar extensions volume
    driver: local # ğŸ’¾ Local driver
  pgadmin-mongo-rest-api-data: # ğŸ’¾ pgAdmin data volume
    driver: local # ğŸ’¾ Local driver
